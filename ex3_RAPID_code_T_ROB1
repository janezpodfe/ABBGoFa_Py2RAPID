MODULE Socket_Communication
    VAR socketdev server_socket;
    VAR socketdev client_socket;
    VAR string received_data;
    VAR string feedback_data;
    VAR pos target_pos;
    VAR jointtarget current_joints;
    VAR robtarget current_pos;
    VAR bool ok;

    ! Define Home Position
    VAR robtarget pHome := [[500,0,620],[0,0,-1,0],[-1,0,-1,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];

    ! Safety Limits
    CONST num max_x := 100;
    CONST num max_y := 100;
    CONST num max_z := 50;

    PROC Main()
        Connect_PC;

        WHILE TRUE DO
            ! Wait for command from Python
            SocketReceive client_socket \Str:=received_data \Time:=WAIT_MAX;

            IF received_data = "EXIT" THEN
                GOTO EndOfProgram;
            ENDIF

            ! Convert string "[x,y,z]" to a pos variable
            ok := StrToVal(received_data, target_pos);

            IF ok THEN
                ! Check Safety Bounds
                IF Abs(target_pos.x) > max_x OR Abs(target_pos.y) > max_y OR Abs(target_pos.z) > max_z THEN
                    SocketSend client_socket \Str:="ERROR: Out of bounds";
                ELSE
                    ! Execute Motion
                    MoveL Offs(pHome, target_pos.x, target_pos.y, target_pos.z), v100, fine, tool0;

                    ! Prepare Feedback Data (Rounded)
                    current_joints := CJointT();
                    current_pos := CRobT();

                    feedback_data := ValToStr(Round(current_pos.trans.x \Dec:=2)) + "," 
                                   + ValToStr(Round(current_pos.trans.y \Dec:=2)) + "," 
                                   + ValToStr(Round(current_pos.trans.z \Dec:=2)) + "|" 
                                   + ValToStr(Round(current_joints.robax.rax_1 \Dec:=2)) + "," 
                                   + ValToStr(Round(current_joints.robax.rax_2 \Dec:=2)) + "," 
                                   + ValToStr(Round(current_joints.robax.rax_3 \Dec:=2)) + "," 
                                   + ValToStr(Round(current_joints.robax.rax_4 \Dec:=2)) + "," 
                                   + ValToStr(Round(current_joints.robax.rax_5 \Dec:=2)) + "," 
                                   + ValToStr(Round(current_joints.robax.rax_6 \Dec:=2));

                    SocketSend client_socket \Str:=feedback_data;
                ENDIF
            ELSE
                SocketSend client_socket \Str:="ERROR: Invalid Format";
            ENDIF
        ENDWHILE

    EndOfProgram:
        SocketClose client_socket;
        SocketClose server_socket;

    ERROR
        IF ERRNO = ERR_SOCK_CLOSED OR ERRNO = ERR_EXCRTYMAX THEN
            SocketClose client_socket;
            SocketClose server_socket;
            Stop; ! Stop execution so you can restart manually
        ENDIF
    ENDPROC

    PROC Connect_PC()
        SocketCreate server_socket;
        SocketBind server_socket, "192.168.125.1", 5000;
        SocketListen server_socket;
        SocketAccept server_socket, client_socket;
    ENDPROC
ENDMODULE